<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DuxV2 | Portfolio</title>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700;800&display=swap");
    :host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;-o-tab-size:4;tab-size:4;font-family:Poppins,sans-serif;font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}
    ::-webkit-scrollbar{width:0px}
    ::-webkit-scrollbar-thumb{background:rgba(25,140,255,.8);border-radius:15px}
    ::-webkit-scrollbar-thumb:hover{background:#555}
    body{margin:0;background:#000;color:#fff;text-align:center}
    header{display:flex;justify-content:space-between;align-items:center;padding:10px 20px}
    .logo{font-size:1.5rem;font-weight:bold}
    h2{color:#198CFF}
    nav a{color:#fff;text-decoration:none;margin-left:20px;font-weight:bold}
    .hero{margin-top:0}
    .hero h1{font-size:3rem;margin:0}
    .hero p{font-size:1.2rem;margin:20px 0}
    .buttons button{font-family:Poppins,sans-serif;padding:15px 20px;margin:10px;font-size:1.1rem;border:none;border-radius:8px;cursor:pointer;font-weight:700}
    .primary{background:#198CFF;color:#fff}
    .secondary{background:#101218;color:#fff}
    .stats{display:flex;justify-content:center;margin-top:20px;margin-bottom:-40px;gap:15px}
    .stat{background:#050505;padding:5px 15px;border-radius:15px;border:1px solid rgba(30,30,30,.4);width:40%;max-width:350px}
    .stat-value{margin-bottom:-15px}
    .games-section{margin-top:0}
    .title2{color:#fff;font-size:2.5rem}
    .games-container{display:flex;flex-wrap:wrap;justify-content:center;gap:10px;padding:40px 0;margin-top:-70px}
    .game{background:#050505;border-radius:12px;border:1px solid rgba(30,30,30,.4);padding:20px;width:200px;text-align:left}
    .game img{width:100%;border-radius:10px}
    .game-title{font-weight:bold;margin:10px 0 10px}
    .game-meta{font-size:.9rem;color:#198CFF}
    .muted{color:#9aa0a6}
  </style>
</head>
<body>
  <header>
    <div class="logo">DuxV2</div>
    <nav>
      <a href="index.html">Home</a>
      <a href="games.html">Games</a>
    </nav>
  </header>

  <section class="games-section" id="games">
    <h2 class="title2">My Games</h2>
    <div class="games-container" id="games-container"></div>
  </section>

  <script>
    const UNIVERSE_IDS = [
      8125621001, // My Singing Garden
      7999303512, // Steal a Rapper
      7552829228, // Dead Defense
      8277323040, // Brainrot Fishing
      8626903958, // Untitled Aimbot Game
    ];

    document.addEventListener("DOMContentLoaded", init);

    async function init() {
      if (!UNIVERSE_IDS.length) return;

      const listEl = document.getElementById("games-container");

      const FIVE_MINUTES = 5 * 60 * 1000;
      const STATS_CACHE_KEY = "duxv2_game_data";
      const ICONS_CACHE_KEY = "duxv2_icon_data";
      const TIMESTAMP_KEY  = "duxv2_last_update";

      let useCache = false;
      const lastUpdate = localStorage.getItem(TIMESTAMP_KEY);
      const cachedStats = localStorage.getItem(STATS_CACHE_KEY);
      const cachedIcons = localStorage.getItem(ICONS_CACHE_KEY);
      if (lastUpdate && cachedStats && cachedIcons) {
        useCache = (Date.now() - Number(lastUpdate)) < FIVE_MINUTES;
      }

      let statsJson, iconsJson;
      try {
        if (useCache) {
          statsJson = JSON.parse(cachedStats);
          iconsJson = JSON.parse(cachedIcons);
        } else {
          const [statsRes, iconsRes] = await Promise.all([
            fetch(`https://games.roproxy.com/v1/games?universeIds=${UNIVERSE_IDS.join(",")}`),
            fetch(`https://thumbnails.roproxy.com/v1/games/icons?universeIds=${UNIVERSE_IDS.join(",")}&size=420x420&format=Png`)
          ]);
          statsJson = await statsRes.json();
          iconsJson = await iconsRes.json();
          localStorage.setItem(STATS_CACHE_KEY, JSON.stringify(statsJson));
          localStorage.setItem(ICONS_CACHE_KEY, JSON.stringify(iconsJson));
          localStorage.setItem(TIMESTAMP_KEY, Date.now().toString());
        }
      } catch (err) {
        console.error("Failed to fetch data:", err);
        return;
      }

      const statsById = Object.create(null);
      (statsJson?.data ?? []).forEach(g => statsById[g.id] = g);

      const iconsById = Object.create(null);
      (iconsJson?.data ?? []).forEach(ic => iconsById[ic.targetId] = ic.imageUrl);

      let totalPlayers = 0;
      let totalVisits  = 0;

      listEl.innerHTML = "";

      // Build game objects
      const games = [];
      for (const id of UNIVERSE_IDS) {
        games.push({
          id,
          game: statsById[id],
          icon: iconsById[id] || ""
        });
      }

      // Sort by active players (descending)
      games.sort((a, b) => {
        const playA = Number(a.game?.playing || 0);
        const playB = Number(b.game?.playing || 0);
        return playB - playA;
      });

      // Render
      for (const { id, game, icon } of games) {
        const card = document.createElement("div");
        card.className = "game";

        if (game) {
          const playing = Number(game.playing || 0);
          const visits  = Number(game.visits || 0);
          totalPlayers += playing;
          totalVisits  += visits;

          card.innerHTML = `
            <img src="${icon}" alt="Game Thumbnail" loading="lazy">
            <div class="game-title">${escapeHtml(game.name || `Universe ${id}`)}</div>
            <div class="game-meta" style="font-weight: bold;">
              ${playing.toLocaleString()} active players<br>
              <div style="color: white; font-weight: normal;">${visits.toLocaleString()} visits</div>
            </div>
          `;
        } else {
          card.innerHTML = `
            <img src="${icon}" alt="Game Thumbnail" loading="lazy">
            <div class="game-title">Universe ${id}</div>
            <div class="game-meta">Data not found</div>
          `;
        }

        listEl.appendChild(card);
      }
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
  </script>
</body>
</html>
